# VR Teleop UI Design / VRテレオペUI設計書

## 概要

Quest 3 VRコントローラーを使用してSO101デュアルアームロボットを操作するためのUI設計。

## コントローラーマッピング

### 左コントローラー → 左アーム
### 右コントローラー → 右アーム

```
Quest 3 Controller Layout:

        [Y/B Button]
    [X/A Button]   [Thumbstick]

      [Trigger] ← 人差し指
        [Grip] ← 中指
```

---

## ボタン機能定義

### グリップボタン（中指）- アーム移動制御

| 状態 | 動作 |
|------|------|
| **押下開始** | 現在のコントローラー位置を原点として記憶 |
| **押下中** | コントローラーの移動量 → アームの移動量（相対移動） |
| **離す** | アーム停止（現在位置を維持） |

**ポイント**:
- グリップを離してもアームは動かない（安全）
- 次にグリップを押したら、その位置から再開
- 好きな姿勢で操作開始できる

---

### トリガー（人差し指）- グリッパー制御

| 値 | 動作 |
|----|------|
| 0.0（離す） | グリッパー全開 |
| 1.0（全押し）| グリッパー全閉 |
| 中間値 | 比例制御 |

---

### サムスティック - 手首回転（将来実装）

| 方向 | 動作 |
|------|------|
| 左右 | wrist_roll 回転 |
| 上下 | （未定義 / 将来用） |

---

### Aボタン（右）/ Xボタン（左）- 原点リセット

| 動作 | 説明 |
|------|------|
| 押下 | 相対モードの原点を現在位置にリセット |

**使用シーン**: アームが変な位置になったとき、現在のコントローラー位置を基準に再設定

---

### Bボタン（右）/ Yボタン（左）- IKリセット

| 動作 | 説明 |
|------|------|
| 押下 | アームを初期姿勢（ホームポジション）に戻す |

**使用シーン**: アームをニュートラル位置に戻したいとき

---

## 動作フロー

### 基本操作フロー

```
1. VRヘッドセット装着
2. コントローラーを持つ
3. グリップを握る → アーム操作開始
   - コントローラーを動かす → アームが追従
   - トリガーを引く → グリッパーが閉じる
4. グリップを離す → アーム停止
5. 好きな位置に手を移動
6. 再度グリップを握る → その位置から操作再開
```

### 座標系マッピング

```
コントローラー動作    →    アーム動作
─────────────────────────────────────
前に押す              →    前方移動 (x+)
後ろに引く            →    後方移動 (x-)
右に動かす            →    右移動 (y-)
左に動かす            →    左移動 (y+)
上に上げる            →    上昇 (z+)
下に下げる            →    下降 (z-)
```

---

## 安全機能

### 1. グリップ必須（Grip-to-Move）
- グリップを握っている間だけアームが動く
- 離すと即座に停止

### 2. 位置クランプ（Position Clamp）
- アームの到達範囲外への移動を制限
- 設定可能な範囲: position_min_xyz, position_max_xyz

### 3. 関節角度変化制限（Delta Limit）- 将来実装
- 1回の更新で動ける最大角度を制限
- 急激な動きを防止

### 4. IKリセットボタン
- いつでもホームポジションに戻れる

---

## 設定パラメータ

```yaml
# グリップ制御
enable_grip_to_move: true
grip_left_button_index: 10   # 左グリップ
grip_right_button_index: 11  # 右グリップ

# 相対モード
enable_relative_mode: true
position_scale: 1.0          # 1:1の動き

# 原点リセット
enable_reset_with_joystick: true
reset_button_index: 0        # A/Xボタン

# IKリセット
enable_ik_reset_button: true
ik_reset_button_index: 1     # B/Yボタン

# グリッパー
enable_gripper_with_trigger: true
gripper_left_axis: 4
gripper_right_axis: 5
```

---

## 状態遷移図

```
                    ┌─────────────┐
                    │   IDLE      │
                    │ (待機状態)   │
                    └──────┬──────┘
                           │ グリップ押下
                           ▼
                    ┌─────────────┐
              ┌────►│  TRACKING   │◄────┐
              │     │ (追従中)     │     │
              │     └──────┬──────┘     │
              │            │            │
    グリップ押下    │ グリップ離す   コントローラー移動
              │            ▼            │
              │     ┌─────────────┐     │
              └─────│   PAUSED    │─────┘
                    │ (一時停止)   │
                    └─────────────┘
```

---

## Quest 3 ボタンインデックス（参考）

```
buttons[0]  = X (左) / A (右)
buttons[1]  = Y (左) / B (右)
buttons[2]  = Menu
buttons[3]  = Thumbstick press (左)
buttons[4]  = Thumbstick press (右)
buttons[10] = Grip (左)
buttons[11] = Grip (右)

axes[0] = Thumbstick X (左)
axes[1] = Thumbstick Y (左)
axes[2] = Thumbstick X (右)
axes[3] = Thumbstick Y (右)
axes[4] = Trigger (左)
axes[5] = Trigger (右)
```

---

---

## ハンドトラッキングモード（コントローラーなし）

コントローラーを使わず、素手で操作するモード。

### ジェスチャーマッピング

| ジェスチャー | 動作 | コントローラー相当 |
|-------------|------|-------------------|
| **ピンチ（親指+人差し指）** | アーム操作開始/停止 | グリップボタン |
| **ピンチ中の手の移動** | アームの移動 | コントローラー移動 |
| **握り込み（グラブ）** | グリッパー閉じる | トリガー |
| **手を開く** | グリッパー開く | トリガー離す |

### 動作フロー

```
1. 素手をカメラに見せる
2. ピンチ → アーム操作開始（その位置が原点）
3. ピンチしたまま手を動かす → アームが追従
4. 握り込む → グリッパーが閉じる
5. ピンチ解除 → アーム停止
```

### 特別ジェスチャー（将来実装）

| ジェスチャー | 動作 |
|-------------|------|
| 両手でサムズアップ | ホームポジションに戻る |
| パー（手を広げる）を2秒維持 | 原点リセット |

### 入力トピック（既存）

```
/quest/left_hand/pose      # 左手位置
/quest/right_hand/pose     # 右手位置
/quest/left_hand/joints    # 左手指関節
/quest/right_hand/joints   # 右手指関節
/quest/hand_gesture/left   # 左手ジェスチャー
/quest/hand_gesture/right  # 右手ジェスチャー
```

---

## 入力モード切り替え

| モード | 検出条件 | 使用トピック |
|--------|----------|-------------|
| コントローラーモード | コントローラー接続時 | /quest/left_controller/pose |
| ハンドトラッキングモード | コントローラー未接続時 | /quest/left_hand/pose |

※ 将来的には自動切り替えを実装

---

## 改善予定

1. [ ] ハプティックフィードバック（グリップ時の振動）
2. [ ] 手首回転のサムスティック制御
3. [ ] 関節角度変化制限（Delta Limit）
4. [ ] VR内でのアーム可視化
5. [ ] 到達不能領域の警告表示
6. [ ] ハンドトラッキング←→コントローラー自動切り替え
7. [ ] ピンチジェスチャーでのアーム制御実装
