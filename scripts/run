#!/bin/bash
# Simple launcher for vlabor profiles

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VR_ROS2_DIR="$(dirname "$SCRIPT_DIR")"
ROS2_WS="$(dirname "$(dirname "$VR_ROS2_DIR")")"
LAUNCH_PID_FILE="/tmp/vr_teleop_launch.pid"

FLUENT_VISION_SRC="$ROS2_WS/src/fluent_vision_ros2"
VLABOR_SRC="$ROS2_WS/src/vlabor_ros2"

# run å†’é ­: fluent_vision / vlabor ã‚’ git pull ã—ã€æ›´æ–°ãŒã‚ã‚Œã° colcon build
# ï¼ˆpull å‰å¾Œã® HEAD æ¯”è¼ƒã§åˆ¤å®šã™ã‚‹ã®ã§ãƒ­ã‚±ãƒ¼ãƒ«ã«ä¾å­˜ã—ãªã„ï¼‰
update_and_build() {
    local need_build=0
    local head_before head_after out

    echo "[run] git pull: fluent_vision_ros2, vlabor_ros2"

    if [ -d "$FLUENT_VISION_SRC/.git" ]; then
        head_before=$(git -C "$FLUENT_VISION_SRC" rev-parse HEAD 2>/dev/null) || true
        out=$(git -C "$FLUENT_VISION_SRC" pull 2>&1) || true
        echo "$out" | sed 's/^/  fv: /'
        head_after=$(git -C "$FLUENT_VISION_SRC" rev-parse HEAD 2>/dev/null) || true
        if [ -n "$head_before" ] && [ -n "$head_after" ] && [ "$head_before" != "$head_after" ]; then
            need_build=1
        fi
    fi

    if [ -d "$VLABOR_SRC/.git" ]; then
        head_before=$(git -C "$VLABOR_SRC" rev-parse HEAD 2>/dev/null) || true
        out=$(git -C "$VLABOR_SRC" pull 2>&1) || true
        echo "$out" | sed 's/^/  vl: /'
        head_after=$(git -C "$VLABOR_SRC" rev-parse HEAD 2>/dev/null) || true
        if [ -n "$head_before" ] && [ -n "$head_after" ] && [ "$head_before" != "$head_after" ]; then
            need_build=1
        fi
    fi

    if [ "$need_build" -eq 1 ]; then
        echo "[run] æ›´æ–°ã‚ã‚Š â†’ colcon build --symlink-install"
        # shellcheck source=/dev/null
        source /opt/ros/humble/setup.bash 2>/dev/null || true
        (cd "$ROS2_WS" && colcon build --symlink-install) || {
            echo "[run] WARN: build ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ—¢å­˜ã® install ã®ã¾ã¾èµ·å‹•ã—ã¾ã™ã€‚" >&2
        }
    else
        echo "[run] æ›´æ–°ãªã— â†’ ãƒ“ãƒ«ãƒ‰ã‚¹ã‚­ãƒƒãƒ—"
    fi
    echo ""
}

print_usage() {
    echo "Usage: run <profile> [key:=value ...]"
    echo ""
    echo "Profiles:"
    echo "  so101_vr_dual_teleop"
    echo "  so101_single_teleop"
    echo "  so101_dual_teleop"
    echo "  vr_server_only"
    echo "  rviz_so101"
    echo "  gazebo_so101"
    echo "  overhead_camera"
    echo ""
    echo "Examples:"
    echo "  run so101_vr_dual_teleop"
    echo "  run rviz_so101 rviz_config:=/path/to/file.rviz"
}

select_profile() {
    local profiles=(
        "so101_single_teleop:å˜è…•ãƒ†ãƒ¬ã‚ªãƒš(leader->follower)"
        "so101_dual_teleop:åŒè…•ãƒ†ãƒ¬ã‚ªãƒš(leader->follower)"
        "so101_vr_dual_teleop:VRåŒè…•ãƒ†ãƒ¬ã‚ªãƒš(æ¨™æº–)"
    )

    local index=0
    local key=""

    while true; do
        printf "\033[2J\033[H"
        echo "Select profile (â†‘/â†“, Enter):"
        for i in "${!profiles[@]}"; do
            local name="${profiles[$i]%%:*}"
            local desc="${profiles[$i]#*:}"
            if [ "$i" -eq "$index" ]; then
                printf "> %s  - %s\n" "$name" "$desc"
            else
                printf "  %s  - %s\n" "$name" "$desc"
            fi
        done

        IFS= read -rsn1 key
        if [ "$key" = "" ]; then
            PROFILE="${profiles[$index]%%:*}"
            return
        fi
        if [ "$key" = $'\x1b' ]; then
            read -rsn2 key
            case "$key" in
                "[A")
                    if [ "$index" -gt 0 ]; then
                        index=$((index - 1))
                    fi
                    ;;
                "[B")
                    if [ "$index" -lt $((${#profiles[@]} - 1)) ]; then
                        index=$((index + 1))
                    fi
                    ;;
            esac
        fi
    done
}

setup_ros2() {
    if [ -f /opt/ros/humble/setup.bash ]; then
        source /opt/ros/humble/setup.bash
    else
        echo "ROS2 Humble not found" >&2
        exit 1
    fi

    if [ -f "$ROS2_WS/install/setup.bash" ]; then
        source "$ROS2_WS/install/setup.bash"
    else
        echo "Workspace not built: $ROS2_WS" >&2
        exit 1
    fi

    if [ -n "$PYTHONPATH" ]; then
        PYTHONPATH="$(echo "$PYTHONPATH" | tr ':' '\n' | grep -v 'python3.13' | paste -sd ':' -)"
    fi
    export PYTHONPATH="/home/takatronix/ros2_ws/install/vr_haptic_msgs/local/lib/python3.10/dist-packages:/home/takatronix/.local/lib/python3.10/site-packages${PYTHONPATH:+:$PYTHONPATH}"
}

setup_display() {
    if [ -z "${DISPLAY:-}" ]; then
        export DISPLAY=":0"
    fi
    if [ -z "${XAUTHORITY:-}" ] && [ -f "$HOME/.Xauthority" ]; then
        export XAUTHORITY="$HOME/.Xauthority"
    fi
}

GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# è¡¨ç¤ºç”¨ãƒ›ã‚¹ãƒˆåï¼ˆvlabor.localï¼‰ã¨ã€å¤–éƒ¨ã‹ã‚‰è¦‹ãŸIPã‚’å–å¾—
HOST_NAME="vlabor.local"
# IPv4 ã®ã¿å–å¾—ï¼ˆIPv6ã‚’å‡ºã•ãªã„ï¼‰
# å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã® IPv4ã€‚Docker ã® 172.17.x.x ã¯é™¤å¤–ã—ã€192.168/10 ã‚’å„ªå…ˆ
get_external_ip() {
    local ip
    # 192.168 / 10 ç³»ã®ã¿ï¼ˆDocker 172.17ã€loopback 127ã€link-local 169.254 ã‚’é™¤ãï¼‰
    ip=$( (getent ahostsv4 vlabor.local 2>/dev/null | awk '{print $1}' ; hostname -I 2>/dev/null | tr ' ' '\n') \
        | grep -E "^(192\.168\.|10\.)[0-9.]+$" | head -1)
    if [ -z "$ip" ]; then
        ip=$(ip -4 route get 1 2>/dev/null | awk '{print $7; exit}')
        case "$ip" in
            127.*|172.1[6-9].*|172.2[0-9].*|172.3[0-1].*|169.254.*) ip=""
        esac
    fi
    if [ -z "$ip" ]; then
        ip=$(hostname -I 2>/dev/null | tr ' ' '\n' | grep -v ':' \
            | grep -E "^(192\.168\.|10\.)" | head -1)
    fi
    echo "$ip"
}

open_browser() {
    local urls=()
    case "$PROFILE" in
        so101_vr_dual_teleop|so101_dual_teleop)
            urls=("http://${HOST_NAME}:8888" "http://${HOST_NAME}:8080" "http://${HOST_NAME}:8081") ;;
        so101_single_teleop)
            urls=("http://${HOST_NAME}:8888" "http://${HOST_NAME}:8080") ;;
        overhead_camera)
            urls=("http://${HOST_NAME}:8888") ;;
        *)  return ;;
    esac

    sleep 3

    for url in "${urls[@]}"; do
        if ssh -o ConnectTimeout=2 -o BatchMode=yes mac "open '$url'" 2>/dev/null; then
            echo -e "${GREEN}ğŸŒ Opened: $url${NC}"
        fi
    done

    local ext_ip
    ext_ip=$(get_external_ip)
    echo ""
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}  Web UI URLs (${HOST_NAME})${NC}"
    echo -e "${CYAN}========================================${NC}"
    for url in "${urls[@]}"; do
        echo -e "  ${GREEN}$url${NC}"
    done
    if [ -n "$ext_ip" ]; then
        echo -e "  å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹: ${GREEN}http://${ext_ip}:8888${NC} ãªã© (åŒã˜ãƒãƒ¼ãƒˆ)"
        echo -e "  vlaborã‚¢ãƒ—ãƒªã‹ã‚‰ã¯ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ ${GREEN}${ext_ip}${NC} ãƒãƒ¼ãƒˆã¯ ${GREEN}42000${NC} ã§æ¥ç¶šã—ã¦ãã ã•ã„"
    fi
    echo -e "${CYAN}========================================${NC}"
    echo ""
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    exit 0
fi

update_and_build

if [ $# -lt 1 ]; then
    select_profile
else
    PROFILE="$1"
    shift
fi

setup_ros2
setup_display

trap 'rm -f "$LAUNCH_PID_FILE"' EXIT

# ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ override å¼•æ•°ã‚’å–å¾—
DEVICE_OVERRIDES=""
if python3 -c "from vlabor_launch.device_mapping import resolve_to_overrides" 2>/dev/null; then
    DEVICE_OVERRIDES=$(python3 -c "
from vlabor_launch.device_mapping import resolve_to_overrides
overrides = resolve_to_overrides('${PROFILE}')
print(' '.join(f'{k}:={v}' for k, v in overrides.items()))
" 2>/dev/null) || true
    if [ -n "$DEVICE_OVERRIDES" ]; then
        echo "[run] ãƒ‡ãƒã‚¤ã‚¹å‰²ã‚Šå½“ã¦é©ç”¨: $DEVICE_OVERRIDES"
    fi
fi

ros2 launch vlabor_launch vlabor.launch.py profile:=${PROFILE} ${DEVICE_OVERRIDES} "$@" &
launch_pid=$!
echo "$launch_pid" > "$LAUNCH_PID_FILE"

open_browser &

wait "$launch_pid"
