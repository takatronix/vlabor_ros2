#!/bin/bash
# Simple launcher for vlabor profiles

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VR_ROS2_DIR="$(dirname "$SCRIPT_DIR")"
ROS2_WS="$(dirname "$(dirname "$VR_ROS2_DIR")")"
LAUNCH_PID_FILE="/tmp/vr_teleop_launch.pid"

print_usage() {
    echo "Usage: run <profile> [key:=value ...]"
    echo ""
    echo "Profiles:"
    echo "  so101_vr_dual_teleop"
    echo "  so101_single_teleop"
    echo "  so101_dual_teleop"
    echo "  vr_server_only"
    echo "  rviz_so101"
    echo "  gazebo_so101"
    echo "  overhead_camera"
    echo ""
    echo "Examples:"
    echo "  run so101_vr_dual_teleop"
    echo "  run rviz_so101 rviz_config:=/path/to/file.rviz"
}

select_profile() {
    local profiles=(
        "so101_single_teleop:å˜è…•ãƒ†ãƒ¬ã‚ªãƒš(leader->follower)"
        "so101_dual_teleop:åŒè…•ãƒ†ãƒ¬ã‚ªãƒš(leader->follower)"
        "so101_vr_dual_teleop:VRåŒè…•ãƒ†ãƒ¬ã‚ªãƒš(æ¨™æº–)"
    )

    local index=0
    local key=""

    while true; do
        printf "\033[2J\033[H"
        echo "Select profile (â†‘/â†“, Enter):"
        for i in "${!profiles[@]}"; do
            local name="${profiles[$i]%%:*}"
            local desc="${profiles[$i]#*:}"
            if [ "$i" -eq "$index" ]; then
                printf "> %s  - %s\n" "$name" "$desc"
            else
                printf "  %s  - %s\n" "$name" "$desc"
            fi
        done

        IFS= read -rsn1 key
        if [ "$key" = "" ]; then
            PROFILE="${profiles[$index]%%:*}"
            return
        fi
        if [ "$key" = $'\x1b' ]; then
            read -rsn2 key
            case "$key" in
                "[A")
                    if [ "$index" -gt 0 ]; then
                        index=$((index - 1))
                    fi
                    ;;
                "[B")
                    if [ "$index" -lt $((${#profiles[@]} - 1)) ]; then
                        index=$((index + 1))
                    fi
                    ;;
            esac
        fi
    done
}

setup_ros2() {
    if [ -f /opt/ros/humble/setup.bash ]; then
        source /opt/ros/humble/setup.bash
    else
        echo "ROS2 Humble not found" >&2
        exit 1
    fi

    if [ -f "$ROS2_WS/install/setup.bash" ]; then
        source "$ROS2_WS/install/setup.bash"
    else
        echo "Workspace not built: $ROS2_WS" >&2
        exit 1
    fi

    if [ -n "$PYTHONPATH" ]; then
        PYTHONPATH="$(echo "$PYTHONPATH" | tr ':' '\n' | grep -v 'python3.13' | paste -sd ':' -)"
    fi
    export PYTHONPATH="/home/takatronix/ros2_ws/install/vr_haptic_msgs/local/lib/python3.10/dist-packages:/home/takatronix/.local/lib/python3.10/site-packages${PYTHONPATH:+:$PYTHONPATH}"
}

setup_display() {
    if [ -z "${DISPLAY:-}" ]; then
        export DISPLAY=":0"
    fi
    if [ -z "${XAUTHORITY:-}" ] && [ -f "$HOME/.Xauthority" ]; then
        export XAUTHORITY="$HOME/.Xauthority"
    fi
}

GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

open_browser() {
    local urls=()
    case "$PROFILE" in
        so101_vr_dual_teleop|so101_dual_teleop)
            urls=("http://localhost:8888" "http://localhost:8080" "http://localhost:8081") ;;
        so101_single_teleop)
            urls=("http://localhost:8888" "http://localhost:8080") ;;
        overhead_camera)
            urls=("http://localhost:8888") ;;
        *)  return ;;
    esac

    sleep 3

    local opened=false
    for url in "${urls[@]}"; do
        if ssh -o ConnectTimeout=2 -o BatchMode=yes mac "open '$url'" 2>/dev/null; then
            echo -e "${GREEN}ðŸŒ Opened: $url${NC}"
            opened=true
        fi
    done

    if [ "$opened" = false ]; then
        echo ""
        echo -e "${CYAN}========================================${NC}"
        echo -e "${CYAN}  Web UI URLs${NC}"
        echo -e "${CYAN}========================================${NC}"
        for url in "${urls[@]}"; do
            echo -e "  ${GREEN}$url${NC}"
        done
        echo -e "${CYAN}========================================${NC}"
        echo ""
    fi
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    print_usage
    exit 0
fi

if [ $# -lt 1 ]; then
    select_profile
else
    PROFILE="$1"
    shift
fi

setup_ros2
setup_display

trap 'rm -f "$LAUNCH_PID_FILE"' EXIT

ros2 launch vlabor_launch vlabor.launch.py profile:=${PROFILE} "$@" &
launch_pid=$!
echo "$launch_pid" > "$LAUNCH_PID_FILE"

open_browser &

wait "$launch_pid"
