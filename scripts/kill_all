#!/bin/bash
# 強制停止: ROS2/関連プロセスを一括終了

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  VR ROS2 強制停止 (kill_all)${NC}"
echo -e "${BLUE}========================================${NC}"

echo -e "${YELLOW}[WARN]${NC} ROS関連プロセスをまとめて停止します"

PATTERNS=(
    "ros2"
    "ros2launch"
    "ros2 launch"
    "rclpy"
    "launch_ros"
    "robot_state_publisher"
    "foxglove_bridge"
    "rviz2"
    "gz"
    "gazebo"
    "so101"
    "unity_tcp_endpoint"
    "fv_camera"
    "lerobot_recorder"
)

FOUND_PIDS=()
for pattern in "${PATTERNS[@]}"; do
    while read -r pid; do
        if [ -n "$pid" ]; then
            FOUND_PIDS+=("$pid")
        fi
    done < <(pgrep -f "$pattern" 2>/dev/null || true)
done

if [ ${#FOUND_PIDS[@]} -eq 0 ]; then
    print_status "該当プロセスなし"
    exit 0
fi

print_status "停止対象PID: ${FOUND_PIDS[*]}"

for pid in "${FOUND_PIDS[@]}"; do
    kill "$pid" 2>/dev/null || true
    sleep 0.2
    if kill -0 "$pid" 2>/dev/null; then
        print_warning "PID $pid を強制終了"
        kill -9 "$pid" 2>/dev/null || true
    fi
done

print_status "=== 停止完了 ==="
